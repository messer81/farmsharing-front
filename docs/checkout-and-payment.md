# üßæ –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –∏ –æ–ø–ª–∞—Ç–∞ (Checkout & Payments)

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Ñ–ª–æ—É –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞, –æ–ø–ª–∞—Ç—ã –∫–∞—Ä—Ç–æ–π (Stripe) –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ FarmSharing.

## üîç –û–±–∑–æ—Ä —Ñ–ª–æ—É

1. –ö–æ—Ä–∑–∏–Ω–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–≤–∞—Ä—ã –∏ –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É
2. –î–æ—Å—Ç–∞–≤–∫–∞: –≤–≤–æ–¥–∏—Ç –∞–¥—Ä–µ—Å –∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
3. –û–ø–ª–∞—Ç–∞: –≤—ã–±–∏—Ä–∞–µ—Ç —Å–ø–æ—Å–æ–± (–Ω–∞–ª–æ–∂–µ–Ω–Ω—ã–π –ø–ª–∞—Ç—ë–∂, –∫–∞—Ä—Ç–∞ Stripe, PayPal ‚Äî placeholder)
4. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ: –∑–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω, –∫–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞, –ø–æ–∫–∞–∑–∞–Ω —Ç–æ—Å—Ç/—ç–∫—Ä–∞–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- `src/features/checkout/ui/CheckoutPage.tsx` ‚Äî —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —á–µ–∫–∞—É—Ç–∞ —Å–æ —Å—Ç–µ–ø–ø–µ—Ä–æ–º –∏ —Ñ–æ—Ä–º–∞–º–∏
- `src/features/checkout/ui/CardPayment.tsx` ‚Äî –æ–ø–ª–∞—Ç–∞ –∫–∞—Ä—Ç–æ–π —á–µ—Ä–µ–∑ Stripe Elements

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (—Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –∏ —Å–µ—Ä–≤–µ—Ä):

```
# Frontend (Vite)
VITE_STRIPE_PUBLISHABLE_KEY=pk_test_xxx

# Backend (server.cjs)
STRIPE_SECRET_KEY=sk_test_xxx
# STRIPE_WEBHOOK_SECRET=whsec_xxx   # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤–µ–±—Ö—É–∫–∏
```

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `VITE_API_URL` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –≤–∞—à backend (`http://localhost:3000/api` –≤ dev).

## üß© UI-—Ñ–ª–æ—É –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

–°—Ç–µ–ø—ã (`CheckoutPage.tsx`):
- –®–∞–≥ 0 ‚Äî –ö–æ—Ä–∑–∏–Ω–∞: —Å–ø–∏—Å–æ–∫ –ø–æ–∑–∏—Ü–∏–π, —Å—É–º–º–∞ (`selectCartItems`, `selectTotalPrice`)
- –®–∞–≥ 1 ‚Äî –î–æ—Å—Ç–∞–≤–∫–∞: –ø–æ–ª—è `name, phone, address, city, zipCode, notes`
  - –í–∞–ª–∏–¥–∞—Ü–∏—è: –≤—Å–µ –ø–æ–ª—è, –∫—Ä–æ–º–µ `notes`, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã
- –®–∞–≥ 2 ‚Äî –û–ø–ª–∞—Ç–∞: –≤—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞
  - –ù–∞–ª–æ–∂–µ–Ω–Ω—ã–π –ø–ª–∞—Ç—ë–∂ (Cash on Delivery)
  - –ö–∞—Ä—Ç–∞ (Stripe) ‚Äî –ø–æ–∫–∞–∑ —Ñ–æ—Ä–º—ã `CardPayment`
  - PayPal ‚Äî placeholder –∫–Ω–æ–ø–∫–∞
- –®–∞–≥ 3 ‚Äî –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ: —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –∑–∞–∫–∞–∑–µ –∏ –∫–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è

–û—à–∏–±–∫–∏/—Å–æ—Å—Ç–æ—è–Ω–∏—è:
- `isCartEmpty` –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø—Ä–∏ –ø—É—Å—Ç–æ–π –∫–æ—Ä–∑–∏–Ω–µ
- `loading` –≤–æ –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞/–æ–ø–ª–∞—Ç—ã
- –û—à–∏–±–∫–∏ Stripe/–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `Alert` –∏ `Snackbar`

## üí≥ –û–ø–ª–∞—Ç–∞ –∫–∞—Ä—Ç–æ–π (Stripe)

–§–æ—Ä–º–∞ –≤ `CardPayment.tsx`:
- –°–æ–∑–¥–∞–Ω–∏–µ PaymentIntent: `apiClient.payments.createPaymentIntent(amount, currency)` ‚Üí `clientSecret`
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ: `stripe.confirmCardPayment(clientSecret, { payment_method: { card } })`
- –£—Å–ø–µ—Ö: `onSuccess(paymentIntent.id)` ‚Äî —Ä–æ–¥–∏—Ç–µ–ª—å –≤—ã–∑—ã–≤–∞–µ—Ç `placeOrder()`

–¢–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã:
- –£—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç—ë–∂: 4242 4242 4242 4242, –ª—é–±–æ–π —Å—Ä–æ–∫/CSV
- –û—à–∏–±–∫–∞: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç-–∫–∞—Ä—Ç—ã Stripe –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:
- –í–∞–ª—é—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî `ils`
- –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ 3DS/SCA –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

## üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞

–í `CheckoutPage.tsx` —Ñ—É–Ω–∫—Ü–∏—è `placeOrder()` –¥–µ–ª–∞–µ—Ç:
1. –í–∞–ª–∏–¥–∞—Ü–∏—è –∞–¥—Ä–µ—Å–∞ –∏ —Å—É–º–º—ã
2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ payload:
   ```ts
   {
     userId: entityUser?.id ?? authUser?.id ?? 0,
     items: items.map(it => ({ productId: it.product.id, quantity: it.quantity })),
     deliveryAddress,       // name, phone, address, city, zipCode, notes
     paymentMethod,         // CASH | CARD | PAYPAL
     paymentId: null | string, // –¥–ª—è –∫–∞—Ä—Ç—ã ‚Äî ID paymentIntent
     totalAmount: total,
     currency: 'ILS'
   }
   ```
3. –í—ã–∑–æ–≤ API: `apiClient.orders.create(payload)`
4. –û—á–∏—Å—Ç–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã: `dispatch(clearCart())`
5. –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —à–∞–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è + —Ç–æ—Å—Ç

–í–∞–∂–Ω–æ: –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –∫–∞—Ä—Ç–æ–π `placeOrder()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ `CardPayment` (—á–µ—Ä–µ–∑ `onSuccess`).

## üß™ API (—Å–µ—Ä–≤–µ—Ä)

–ü–ª–∞—Ç–µ–∂–∏:
- `POST /api/payments/create-intent` ‚Äî —Å–æ–∑–¥–∞—Ç—å PaymentIntent
  - Request: `{ amount: number, currency: string }`
  - Response: `{ clientSecret: string }`

–ó–∞–∫–∞–∑—ã:
- `POST /api/orders` ‚Äî —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑
  - Request: –æ–±—ä–µ–∫—Ç, –æ–ø–∏—Å–∞–Ω–Ω—ã–π –≤—ã—à–µ
  - Response: `{ data: Order, success: true }`

–°—Ö–µ–º–∞ `Order` (—É–ø—Ä–æ—â—ë–Ω–Ω–æ):
```ts
type Order = {
  id: number;
  userId: number;
  items: { productId: number; quantity: number }[];
  totalAmount: number;
  paymentMethod: 'CASH' | 'CARD' | 'PAYPAL';
  paymentId?: string | null;
  createdAt: string;
};
```

## üßØ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

- –í–∞–ª–∏–¥–∞—Ü–∏—è –∞–¥—Ä–µ—Å–∞: –ø–æ–∫–∞–∑–∞—Ç—å `Alert` –∏ —É–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Ç–µ–∫—É—â–∏–π —à–∞–≥
- –û—à–∏–±–∫–∏ Stripe: –≤—ã–≤–æ–¥ —á–µ—Ä–µ–∑ `Alert` –≤ `CardPayment`
- –û—à–∏–±–∫–∏ API: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ `e.response.data.message` –ª–∏–±–æ fallback

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

1. –ü—É—Å—Ç–∞—è –∫–æ—Ä–∑–∏–Ω–∞ ‚Äî —á–µ–∫–∞—É—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
2. –í–∞–ª–∏–¥–Ω—ã–π –∞–¥—Ä–µ—Å ‚Üí –º–æ–∂–Ω–æ –ø–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ
3. CASH: `placeOrder()` —É—Å–ø–µ—à–µ–Ω, –∫–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞, —à–∞–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏ —Ç–æ—Å—Ç
4. CARD: —É—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞ (4242‚Ä¶), –∑–∞—Ç–µ–º `placeOrder()`, –æ—á–∏—Å—Ç–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
5. CARD: –æ—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã ‚Äî —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ, –∑–∞–∫–∞–∑ –Ω–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è
6. PAYPAL: –∫–Ω–æ–ø–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è (–ø–æ–∫–∞ –±–µ–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã)
7. i18n: —Ç–µ–∫—Å—Ç—ã —à–∞–≥–æ–≤, –æ—à–∏–±–æ–∫ –∏ –∫–Ω–æ–ø–æ–∫ –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω—ã
8. –°–≤–µ—Ç–ª–∞—è/—Ç—ë–º–Ω–∞—è —Ç–µ–º–∞: –∫–Ω–æ–ø–∫–∏ –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤—ã–≥–ª—è–¥—è—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

–û–±–Ω–æ–≤–ª–µ–Ω–æ: –ê–≤–≥—É—Å—Ç 2025

